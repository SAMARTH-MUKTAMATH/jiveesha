generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================
// PHASE 0: Authentication & Users
// ============================================

model User {
  id                          String    @id @default(uuid())
  email                       String    @unique
  passwordHash                String    @map("password_hash")
  role                        String    @default("clinician")
  status                      String    @default("pending_verification")
  emailVerified               Boolean   @default(false) @map("email_verified")
  emailVerificationToken      String?   @map("email_verification_token")
  emailVerificationExpires    DateTime? @map("email_verification_expires")
  passwordResetToken          String?   @map("password_reset_token")
  passwordResetExpires        DateTime? @map("password_reset_expires")
  createdAt                   DateTime  @default(now()) @map("created_at")
  updatedAt                   DateTime  @updatedAt @map("updated_at")
  lastLoginAt                 DateTime? @map("last_login_at")
  deletedAt                   DateTime? @map("deleted_at")

  profile                     ClinicianProfile?
  credentials                 Credential[]
  refreshTokens               RefreshToken[]
  patients                    Patient[]
  appointments                Appointment[]
  sessions                    ConsultationSession[]
  auditLogs                   AuditLog[]
  locations                   PracticeLocation[]
  availability                ClinicianAvailability[]
  timeOff                     ClinicianTimeOff[]
  preferences                 UserPreferences?
  
  @@map("users")
}

model ClinicianProfile {
  id                    String    @id @default(uuid())
  userId                String    @unique @map("user_id")
  firstName             String    @map("first_name")
  middleName            String?   @map("middle_name")
  lastName              String    @map("last_name")
  professionalTitle     String?   @map("professional_title")
  designation           String?
  specializations       String    @default("[]")
  languages             String    @default("[]")
  phone                 String?
  alternatePhone        String?   @map("alternate_phone")
  dateOfBirth           DateTime? @map("date_of_birth")
  yearsOfPractice       Int?      @map("years_of_practice")
  bio                   String?
  photoUrl              String?   @map("photo_url")
  verificationStatus    String    @default("pending") @map("verification_status")
  verifiedAt            DateTime? @map("verified_at")
  verifiedBy            String?   @map("verified_by")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("clinician_profiles")
}

model Credential {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")
  credentialType        String    @map("credential_type")
  credentialNumber      String?   @map("credential_number")
  issuingAuthority      String?   @map("issuing_authority")
  issueDate             DateTime? @map("issue_date")
  expiryDate            DateTime? @map("expiry_date")
  documentUrl           String?   @map("document_url")
  verificationStatus    String    @default("pending") @map("verification_status")
  verificationNotes     String?   @map("verification_notes")
  verifiedBy            String?   @map("verified_by")
  verifiedAt            DateTime? @map("verified_at")
  rejectionReason       String?   @map("rejection_reason")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("credentials")
}

model RefreshToken {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")
  token                 String    @unique
  expiresAt             DateTime  @map("expires_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  revokedAt             DateTime? @map("revoked_at")
  ipAddress             String?   @map("ip_address")
  userAgent             String?   @map("user_agent")

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("refresh_tokens")
}

model AuditLog {
  id                    String    @id @default(uuid())
  userId                String?   @map("user_id")
  action                String
  resourceType          String?   @map("resource_type")
  resourceId            String?   @map("resource_id")
  ipAddress             String?   @map("ip_address")
  userAgent             String?   @map("user_agent")
  details               String?
  createdAt             DateTime  @default(now()) @map("created_at")

  user                  User?     @relation(fields: [userId], references: [id])
  
  @@map("audit_logs")
}

// ============================================
// PHASE 1: Settings & Locations
// ============================================

model PracticeLocation {
  id                    String    @id @default(uuid())
  clinicianId           String    @map("clinician_id")
  name                  String
  addressLine1          String?   @map("address_line1")
  addressLine2          String?   @map("address_line2")
  city                  String?
  state                 String?
  pinCode               String?   @map("pin_code")
  country               String    @default("India")
  roomInfo              String?   @map("room_info")
  isPrimary             Boolean   @default(false) @map("is_primary")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  clinician             User      @relation(fields: [clinicianId], references: [id], onDelete: Cascade)
  availability          ClinicianAvailability[]
  appointments          Appointment[]
  
  @@map("practice_locations")
}

model ClinicianAvailability {
  id                    String    @id @default(uuid())
  clinicianId           String    @map("clinician_id")
  dayOfWeek             Int       @map("day_of_week")
  startTime             String    @map("start_time")
  endTime               String    @map("end_time")
  locationId            String?   @map("location_id")
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  clinician             User      @relation(fields: [clinicianId], references: [id], onDelete: Cascade)
  location              PracticeLocation? @relation(fields: [locationId], references: [id])
  
  @@unique([clinicianId, dayOfWeek, startTime, locationId])
  @@map("clinician_availability")
}

model ClinicianTimeOff {
  id                    String    @id @default(uuid())
  clinicianId           String    @map("clinician_id")
  startDate             DateTime  @map("start_date")
  endDate               DateTime  @map("end_date")
  reason                String?
  allDay                Boolean   @default(true) @map("all_day")
  startTime             String?   @map("start_time")
  endTime               String?   @map("end_time")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  clinician             User      @relation(fields: [clinicianId], references: [id], onDelete: Cascade)

  @@map("clinician_time_off")
}

model UserPreferences {
  userId                String    @id @map("user_id")
  language              String    @default("en")
  timezone              String    @default("Asia/Kolkata")
  dateFormat            String    @default("DD/MM/YYYY") @map("date_format")
  timeFormat            String    @default("12-hour") @map("time_format")
  theme                 String    @default("light")
  notificationEmail     Boolean   @default(true) @map("notification_email")
  notificationSms       Boolean   @default(true) @map("notification_sms")
  notificationPush      Boolean   @default(true) @map("notification_push")
  notificationSettings  String    @default("{}") @map("notification_settings")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ============================================
// PHASE 2: Patient Management
// ============================================

model Patient {
  id                    String    @id @default(uuid())
  clinicianId           String    @map("clinician_id")
  
  firstName             String    @map("first_name")
  middleName            String?   @map("middle_name")
  lastName              String    @map("last_name")
  dateOfBirth           DateTime  @map("date_of_birth")
  gender                String?
  placeOfBirth          String?   @map("place_of_birth")
  
  addressLine1          String?   @map("address_line1")
  addressLine2          String?   @map("address_line2")
  city                  String?
  state                 String?
  pinCode               String?   @map("pin_code")
  country               String    @default("India")
  
  primaryLanguage       String?   @map("primary_language")
  languagesSpoken       String    @default("[]") @map("languages_spoken")
  udidNumber            String?   @map("udid_number")
  aadhaarEncrypted      String?   @map("aadhaar_encrypted")
  schoolId              String?   @map("school_id")
  
  primaryConcerns       String?   @map("primary_concerns")
  existingDiagnosis     String?   @map("existing_diagnosis")
  diagnosisCodes        String    @default("[]") @map("diagnosis_codes")
  developmentalMilestones String? @map("developmental_milestones")
  medicalHistory        String?   @map("medical_history")
  currentMedications    String    @default("[]") @map("current_medications")
  allergies             String?
  familyHistory         String?   @map("family_history")
  
  status                String    @default("active")
  referralSource        String?   @map("referral_source")
  referralDetails       String?   @map("referral_details")
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  clinician             User      @relation(fields: [clinicianId], references: [id])
  contacts              PatientContact[]
  documents             PatientDocument[]
  tags                  PatientTag[]
  activityLog           PatientActivityLog[]
  appointments          Appointment[]
  sessions              ConsultationSession[]
  assessments           Assessment[]
  
  @@map("patients")
}

model PatientContact {
  id                    String    @id @default(uuid())
  patientId             String    @map("patient_id")
  contactType           String    @map("contact_type")
  relationship          String?
  firstName             String    @map("first_name")
  lastName              String    @map("last_name")
  phone                 String?
  alternatePhone        String?   @map("alternate_phone")
  email                 String?
  whatsappNumber        String?   @map("whatsapp_number")
  occupation            String?
  addressLine1          String?   @map("address_line1")
  addressLine2          String?   @map("address_line2")
  city                  String?
  state                 String?
  pinCode               String?   @map("pin_code")
  isPrimaryContact      Boolean   @default(false) @map("is_primary_contact")
  canReceiveUpdates     Boolean   @default(true) @map("can_receive_updates")
  preferredContactMethod String?  @map("preferred_contact_method")
  languagePreference    String?   @map("language_preference")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  patient               Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@map("patient_contacts")
}

model PatientDocument {
  id                    String    @id @default(uuid())
  patientId             String    @map("patient_id")
  documentType          String?   @map("document_type")
  fileName              String    @map("file_name")
  fileUrl               String    @map("file_url")
  fileSize              Int?      @map("file_size")
  mimeType              String?   @map("mime_type")
  uploadedBy            String    @map("uploaded_by")
  uploadedAt            DateTime  @default(now()) @map("uploaded_at")
  notes                 String?

  patient               Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@map("patient_documents")
}

model PatientTag {
  patientId             String    @map("patient_id")
  tag                   String
  createdAt             DateTime  @default(now()) @map("created_at")

  patient               Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@id([patientId, tag])
  @@map("patient_tags")
}

model PatientActivityLog {
  id                    String    @id @default(uuid())
  patientId             String    @map("patient_id")
  activityType          String    @map("activity_type")
  description           String?
  metadata              String?
  createdBy             String    @map("created_by")
  createdAt             DateTime  @default(now()) @map("created_at")

  patient               Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@map("patient_activity_log")
}

// ============================================
// PHASE 3: Scheduling
// ============================================

model Appointment {
  id                    String    @id @default(uuid())
  patientId             String    @map("patient_id")
  clinicianId           String    @map("clinician_id")
  date                  DateTime
  startTime             String    @map("start_time")
  endTime               String    @map("end_time")
  appointmentType       String    @map("appointment_type")
  format                String
  locationId            String?   @map("location_id")
  status                String    @default("scheduled")
  seriesId              String?   @map("series_id")
  notes                 String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  patient               Patient   @relation(fields: [patientId], references: [id])
  clinician             User      @relation(fields: [clinicianId], references: [id])
  location              PracticeLocation? @relation(fields: [locationId], references: [id])
  participants          AppointmentParticipant[]
  reminders             AppointmentReminder[]
  history               AppointmentHistory[]
  
  @@map("appointments")
}

model AppointmentParticipant {
  id                    String    @id @default(uuid())
  appointmentId         String    @map("appointment_id")
  participantType       String    @map("participant_type")
  participantId         String?   @map("participant_id")
  participantName       String?   @map("participant_name")
  createdAt             DateTime  @default(now()) @map("created_at")

  appointment           Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  @@map("appointment_participants")
}

model AppointmentReminder {
  id                    String    @id @default(uuid())
  appointmentId         String    @map("appointment_id")
  reminderType          String    @map("reminder_type")
  sentAt                DateTime? @map("sent_at")
  createdAt             DateTime  @default(now()) @map("created_at")

  appointment           Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  @@map("appointment_reminders")
}

model AppointmentHistory {
  id                    String    @id @default(uuid())
  appointmentId         String    @map("appointment_id")
  changeType            String    @map("change_type")
  oldValue              String?   @map("old_value")
  newValue              String?   @map("new_value")
  reason                String?
  changedBy             String    @map("changed_by")
  changedAt             DateTime  @default(now()) @map("changed_at")

  appointment           Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  @@map("appointment_history")
}

// ============================================
// PHASE 4: Consultation Sessions
// ============================================

model ConsultationSession {
  id                    String    @id @default(uuid())
  patientId             String    @map("patient_id")
  clinicianId           String    @map("clinician_id")
  sessionDate           DateTime  @map("session_date")
  duration              Int
  sessionType           String    @map("session_type")
  format                String
  location              String?
  notes                 String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  patient               Patient   @relation(fields: [patientId], references: [id])
  clinician             User      @relation(fields: [clinicianId], references: [id])
  attachments           SessionAttachment[]
  
  @@map("consultation_sessions")
}

model SessionAttachment {
  id                    String    @id @default(uuid())
  sessionId             String    @map("session_id")
  fileType              String    @map("file_type")
  fileUrl               String    @map("file_url")
  uploadedAt            DateTime  @default(now()) @map("uploaded_at")

  session               ConsultationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("session_attachments")
}

// ============================================
// PHASE 5: Assessments
// ============================================

model Assessment {
  id                    String    @id @default(uuid())
  patientId             String    @map("patient_id")
  assessmentType        String    @map("assessment_type")
  status                String    @default("in_progress")
  responses             String    @default("{}")
  currentQuestion       Int?      @map("current_question")
  totalScore            Int?      @map("total_score")
  domainScores          String?   @map("domain_scores")
  interpretation        String?
  completedAt           DateTime? @map("completed_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  patient               Patient   @relation(fields: [patientId], references: [id])
  
  @@map("assessments")
}
